@model IEnumerable<CMCS_Prototype.Models.Claim>

@{
    ViewData["Title"] = "Pending Claims for Review";
    // Define the current controller based on the view being used (e.g., Coordinator)
    // This assumes the file is in the Views/Coordinator/ folder.
    var currentController = ViewContext.RouteData.Values["controller"].ToString();
}

<h2 class="text-primary mb-4"><i class="bi bi-list-check"></i> Claims Awaiting Review</h2>
<hr />

@* Display success/error messages passed via TempData (optional but recommended for UX) *@
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">@TempData["SuccessMessage"]</div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
}

@if (!Model.Any())
{
    <div class="alert alert-success" role="alert">
        <strong>Success!</strong> There are currently no claims pending your review.
    </div>
}
else
{
    @* Note: The claims shown here depend on the logged-in user and their controller's filter logic. *@
    <p>Found <strong>@Model.Count()</strong> claims with 'Pending' status.</p>

    <div class="table-responsive">
        <table class="table table-hover table-striped">
            <thead>
                <tr>
                    <th>Claim No.</th>
                    <th>Lecturer</th>
                    <th>Date Submitted</th>
                    <th class="text-end">Total Hours</th>
                    <th class="text-end">Total Amount (R)</th>
                    <th>Status</th>
                    <th style="width: 20%;">Action</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>
                            @* FIX: Use the determined 'currentController' to dynamically set the target. *@
                            <a asp-controller="@currentController" asp-action="ClaimDetails" asp-route-id="@item.ClaimID" class="fw-bold">
                                @Html.DisplayFor(modelItem => item.ClaimNumber)
                            </a>
                        </td>

                        <td>@Html.DisplayFor(modelItem => item.Lecturer.Name)</td>

                        <td>@Html.DisplayFor(modelItem => item.DateSubmitted)</td>
                        <td class="text-end">@Html.DisplayFor(modelItem => item.TotalHours)</td>

                        <td class="text-end text-success fw-bold">R@(item.TotalAmount.ToString("N2"))</td>

                        <td><span class="badge bg-warning">@item.Status</span></td>
                        <td>
                            @* Approve Button (must use the current controller for routing) *@
                            <form asp-controller="@currentController" asp-action="Approve" asp-route-id="@item.ClaimID" method="post" style="display:inline;">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-success btn-sm me-2"
                                        onclick="return confirm('Are you sure you want to approve this claim? It will be sent for the next stage of approval.');">
                                    <i class="bi bi-check-circle"></i> Approve
                                </button>
                            </form>

                            @* Reject Button (Calls JS function to prompt for reason) *@
                            <button type="button" class="btn btn-danger btn-sm"
                                    onclick="rejectClaim('@item.ClaimID', '@item.ClaimNumber')">
                                <i class="bi bi-x-circle"></i> Reject
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@section Scripts {
    <script>
        function rejectClaim(claimId, claimNumber) {
            var reason = prompt("Enter rejection reason for Claim " + claimNumber + ":");

            if (reason) {
                var form = document.createElement('form');
                form.method = 'post';
                // IMPORTANT: The JS action needs the full path including the current controller
                form.action = '/' + '@currentController' + '/Reject/' + claimId;

                // Get Anti-Forgery Token from the page
                var token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                form.innerHTML += '<input type="hidden" name="__RequestVerificationToken" value="' + token + '" />';

                form.innerHTML += '<input type="hidden" name="id" value="' + claimId + '" />';
                form.innerHTML += '<input type="hidden" name="reason" value="' + reason + '" />';

                document.body.appendChild(form);
                form.submit();
            } else if (reason !== null) {
                alert('Rejection cancelled or reason not provided. Please try again.');
            }
        }
    </script>
}